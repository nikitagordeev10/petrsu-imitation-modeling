// ================================= Функции для решения задачи =================================

// Функция генерации стандартного нормального распределения (метод Бокса-Мюллера)
Функция СгенерироватьНормальнуюСлучайнуюВеличину()          
    СлучайноеЧисло1 = ?(Математика.СлучайноеЧислоОт0До1() = 0, 0.0001, Математика.СлучайноеЧислоОт0До1());
    СлучайноеЧисло2 = ?(Математика.СлучайноеЧислоОт0До1() = 0, 0.0001, Математика.СлучайноеЧислоОт0До1());
    Возврат Sqrt(-2.0 * Log(СлучайноеЧисло1)) * Cos(2.0 * Математика.Пи() * СлучайноеЧисло2);
КонецФункции

Процедура РассчитатьVaRПортфеля(КоличествоВидовБумаг, КоличествоСимуляций, СрокИнвестирования, 
    УровеньДоверия, НачальныеЦеныБумаг, ОжидаемыеДоходности, ВолатильностиБумаг, КоличестваБумагВПортфеле)
    
    // Расчет начальной стоимости портфеля
    НачальнаяСтоимостьПортфеля = 0.0;
    Для НомерВида = 0 По КоличествоВидовБумаг - 1 Цикл
        НачальнаяСтоимостьПортфеля = НачальнаяСтоимостьПортфеля + КоличестваБумагВПортфеле[НомерВида] * НачальныеЦеныБумаг[НомерВида];
    КонецЦикла;
    
    // Массив для хранения потерь по каждой симуляции
    ПотериПортфеля = Новый Массив(КоличествоСимуляций);
    
    // Моделирование методом Монте-Карло
    Для НомерСимуляции = 0 По КоличествоСимуляций - 1 Цикл
        КонечнаяСтоимостьПортфеля = 0.0;
        
        Для НомерВида = 0 По КоличествоВидовБумаг - 1 Цикл
            // Генерация случайной составляющей
            СлучайнаяКомпонента = СгенерироватьНормальнуюСлучайнуюВеличину();
            
            // Расчет будущей цены по модели геометрического броуновского движения
            КонечнаяЦена = НачальныеЦеныБумаг[НомерВида] * Exp(
                (ОжидаемыеДоходности[НомерВида] - 0.5 * ВолатильностиБумаг[НомерВида] * ВолатильностиБумаг[НомерВида]) * СрокИнвестирования + 
                ВолатильностиБумаг[НомерВида] * Sqrt(СрокИнвестирования) * СлучайнаяКомпонента
            );
            
            КонечнаяСтоимостьПортфеля = КонечнаяСтоимостьПортфеля + КоличестваБумагВПортфеле[НомерВида] * КонечнаяЦена;
        КонецЦикла;
        
        // Расчет потерь для данной симуляции
        ПотериПортфеля[НомерСимуляции] = НачальнаяСтоимостьПортфеля - КонечнаяСтоимостьПортфеля;
    КонецЦикла;
	
	МассивДляСортировки = Новый СписокЗначений;
    Для Каждого Потеря Из ПотериПортфеля Цикл
        МассивДляСортировки.Добавить(Потеря);
    КонецЦикла;
    
    МассивДляСортировки.СортироватьПоЗначению(НаправлениеСортировки.Возр);
    
    // Вычисление VaR как соответствующего квантиля
    ИндексКвантиля = Цел(КоличествоСимуляций * (1 - УровеньДоверия));
    Если ИндексКвантиля >= КоличествоСимуляций Тогда
        ИндексКвантиля = КоличествоСимуляций - 1;
    КонецЕсли;
    
    ЗначениеVaR = МассивДляСортировки[ИндексКвантиля].Значение;
    
    // Вывод результатов
    Сообщить("Результаты расчета VaR:");
    Сообщить("----------------------------------");                                                                                  
	Сообщить("Начальная стоимость портфеля: " + Формат(НачальнаяСтоимостьПортфеля, "ЧДЦ=2"));
    Сообщить("Уровень доверия: " + (1 - УровеньДоверия));
    Сообщить("Value at Risk (VaR) - с вероятностью 95% потери не превысят: " + Формат(ЗначениеVaR, "ЧДЦ=2") + " денежных единиц за год");
	Сообщить("Value at Risk (VaR) - с вероятностью 5% потери превысят: " + Формат(ЗначениеVaR, "ЧДЦ=2") + " денежных единиц за год");
    Сообщить("Количество симуляций: " + КоличествоСимуляций);

КонецПроцедуры

// ================================= Команды формы =================================

&НаКлиенте
Процедура ВыполнитьРасчетVaR(Команда)
    
    // Параметры расчета
    КоличествоВидовБумаг = 3;       // Три вида ценных бумаг
    КоличествоСимуляций = 1000;     // 1000 симуляций Монте-Карло
    СрокИнвестирования = 1.0;        // 1 год
    УровеньДоверия = 0.05;           // 95% доверительный уровень
    
    // Параметры ценных бумаг
    НачальныеЦеныБумаг = Новый Массив(КоличествоВидовБумаг);
    НачальныеЦеныБумаг[0] = 100.0; // Начальная стоимость для бумаги 1
    НачальныеЦеныБумаг[1] = 50.0;  // Начальная стоимость для бумаги 2
    НачальныеЦеныБумаг[2] = 80.0;  // Начальная стоимость для бумаги 3
    
    ОжидаемыеДоходности = Новый Массив(КоличествоВидовБумаг);
    ОжидаемыеДоходности[0] = 0.05; // Средний рост для бумаги 1
    ОжидаемыеДоходности[1] = 0.03; // Средний рост для бумаги 2
    ОжидаемыеДоходности[2] = 0.04; // Средний рост для бумаги 3
    
    ВолатильностиБумаг = Новый Массив(КоличествоВидовБумаг);
    ВолатильностиБумаг[0] = 0.2;  // Волатильность для бумаги 1
    ВолатильностиБумаг[1] = 0.15; // Волатильность для бумаги 2
    ВолатильностиБумаг[2] = 0.25; // Волатильность для бумаги 3
    
    КоличестваБумагВПортфеле = Новый Массив(КоличествоВидовБумаг);
    КоличестваБумагВПортфеле[0] = 10; // Количество бумаг 1 в портфеле
    КоличестваБумагВПортфеле[1] = 20; // Количество бумаг 2 в портфеле
    КоличестваБумагВПортфеле[2] = 30; // Количество бумаг 3 в портфеле
    
    // Вызов функции расчета VaR
    РассчитатьVaRПортфеля(КоличествоВидовБумаг, КоличествоСимуляций, СрокИнвестирования, 
        УровеньДоверия, НачальныеЦеныБумаг, ОжидаемыеДоходности, ВолатильностиБумаг, КоличестваБумагВПортфеле);
    
КонецПроцедуры