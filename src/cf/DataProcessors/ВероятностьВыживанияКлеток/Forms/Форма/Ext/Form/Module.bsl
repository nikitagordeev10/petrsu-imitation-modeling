// ================================= Вспомогательные функции =================================

// Функция для генерации времени гибели клетки с экспоненциальным распределением
&НаКлиенте
Функция СгенерироватьВремяГибелиКлетки(ИнтенсивностьГибели)
	РавномерноРаспределенноеЧисло = Математика.СлучайноеЧислоОт0До1();
    Возврат -Log(1 - РавномерноРаспределенноеЧисло) / ИнтенсивностьГибели;
КонецФункции

// Вспомогательная функция для нахождения максимального значения в массиве
&НаКлиенте
Функция МаксимальноеЗначение(Массив)
    Максимум = Массив[0];
	
	Для Индекс = 1 По Массив.Количество() - 1 Цикл
        Если Массив[Индекс] > Максимум Тогда
            Максимум = Массив[Индекс];
        КонецЕсли;
	КонецЦикла;
	
    Возврат Максимум;
КонецФункции

// ================================= Основная функция =================================

// Основная функция для оценки вероятности выживания здоровых клеток
&НаКлиенте
Функция ОценитьВероятностьТогоЧтоКакМинмумКЗдоровыхКлетокПереживутЗлокачественные(
        КоличествоЗлокачественныхКлеток, КоличествоЗдоровыхКлеток, МинимальноеТребуемоеКоличествоВыжившихЗдоровыхКлеток,
        ИнтенсивностьГибелиЗлокачественныхКлеток, ИнтенсивностьГибелиЗдоровыхКлеток, КоличествоМоделирований)
    
    КоличествоБлагоприятныхИсходов = 0;

    Для НомерМоделирования = 1 По КоличествоМоделирований Цикл
        // Моделируем время гибели каждой злокачественной клетки
        ВремяГибелиЗлокачественныхКлеток = Новый Массив;
        Для НомерЗлокачественнойКлетки = 1 По КоличествоЗлокачественныхКлеток Цикл
            ВремяГибелиЗлокачественныхКлеток.Добавить(СгенерироватьВремяГибелиКлетки(ИнтенсивностьГибелиЗлокачественныхКлеток));
        КонецЦикла;

        // Моделируем время гибели каждой здоровой клетки
        ВременаГибелиЗдоровыхКлеток = Новый Массив;
        Для НомерЗдоровойКлетки = 1 По КоличествоЗдоровыхКлеток Цикл
            ВременаГибелиЗдоровыхКлеток.Добавить(
                СгенерироватьВремяГибелиКлетки(ИнтенсивностьГибелиЗдоровыхКлеток));
        КонецЦикла;

        // Находим момент полной гибели всех злокачественных клеток
        МоментГибелиПоследнейЗлокачественнойКлетки = МаксимальноеЗначение(ВремяГибелиЗлокачественныхКлеток);

        // Определяем пороговое время для выживания нужного количества здоровых клеток
        Математика.СортироватьМассивПоУбыванию(ВременаГибелиЗдоровыхКлеток);
        
        Если МинимальноеТребуемоеКоличествоВыжившихЗдоровыхКлеток <= КоличествоЗдоровыхКлеток Тогда
            ПороговоеВремяВыживания = ВременаГибелиЗдоровыхКлеток[МинимальноеТребуемоеКоличествоВыжившихЗдоровыхКлеток - 1];
        Иначе
            ПороговоеВремяВыживания = 0;
        КонецЕсли;

        // Проверяем условие: все злокачественные погибли до того, как осталось менее k здоровых
        Если МоментГибелиПоследнейЗлокачественнойКлетки < ПороговоеВремяВыживания Тогда
            КоличествоБлагоприятныхИсходов = КоличествоБлагоприятныхИсходов + 1;
        КонецЕсли;
    КонецЦикла;

    Возврат КоличествоБлагоприятныхИсходов / КоличествоМоделирований;
КонецФункции

// ================================= Команды формы =================================
&НаКлиенте
Процедура РассчитатьИВывестиРезультат(Команда)
	
	КоличествоЗлокачественныхКлеток = 5;
    КоличествоЗдоровыхКлеток = 10;
	
	МинимальноеТребуемоеКоличествоВыживших = 3;
    ИнтенсивностьГибелиРаковыхКлеток = 1.0;
    ИнтенсивностьГибелиНормальныхКлеток = 0.5;
    КоличествоСтатистическихИспытаний = 1000;

    ВероятностьВыживания = ОценитьВероятностьТогоЧтоКакМинмумКЗдоровыхКлетокПереживутЗлокачественные(
        КоличествоЗлокачественныхКлеток, КоличествоЗдоровыхКлеток, МинимальноеТребуемоеКоличествоВыживших,
        ИнтенсивностьГибелиРаковыхКлеток, ИнтенсивностьГибелиНормальныхКлеток, КоличествоСтатистическихИспытаний);
        
    Сообщить("Вероятность того, что хотя бы " + МинимальноеТребуемоеКоличествоВыживших + 
		" здоровых клеток переживут все злокачественные: " + Формат(ВероятностьВыживания, "ЧДЦ=4; ЧГ=0")); 
	
КонецПроцедуры